{% extends 'common/home.html' %}

{% block content %}

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<h1>Messages List</h1>

<table id="messages" class="table table-striped table-bordered" cellspacing="0" width="100%">
    <thead>
        <tr>
            <th>Id</th>
            <th>Mensagem</th>
            <th>created_date</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="messages-body">
        {% for message in messages %}
        <tr id="message-{{ message.id }}">
            <td>{{ message.id }}</td>
            <td>{{ message.message|default:'' }}</td>
            <td>{{ message.created_date }}</td>
            <td>
                <a class="btn btn-xs btn-info command-edit" href="{% url 'messages_edit' message.id %}">
                    <i class="fa fa-pencil" aria-hidden="true"></i>
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="messages-container"></div>


<script>
    const socket = io("http://localhost:8001"); // Substitua pela URL do backend

    socket.on("connect", () => {
        console.log("Conectado ao WebSocket");
    });
    socket.on("disconnect", () => {
        console.log("Desconectado do WebSocket");
    });

    socket.on("new_message_to_web", (message) => {
        console.log("Nova mensagem recebida:", message);
        addMessageToContainer(message);
    });


    socket.on("message_updated", (message) => {
        console.log("Mensagem atualizada:", message);
        updateMessageInContainer(message);
    });

    function addMessageToContainer(message) {
        const tableBody = document.getElementById("messages-body");

        // Cria uma nova linha para a mensagem
        const row = document.createElement("tr");
        row.id = `message-${message.id}`;
        row.innerHTML = `
        <td>${message.id}</td>
        <td>${message.message || ''}</td>
        <td>${message.created_date}</td>
        <td>
            <a class="btn btn-xs btn-info command-edit" href="/messages/edit/${message.id}">
                <i class="fa fa-pencil" aria-hidden="true"></i>
            </a>
        </td>
    `;

        // Adiciona a nova linha ao final da tabela
        tableBody.appendChild(row);
    }


</script>


{% endblock %}
